# This pipeline is responsible for running Pytest to check your image, as well as building your docker Image.
# To run:
# - Rename the file to docker-image.yml
# - Add 2 secrets to the Github secrets of your repo:
# 1. Your Docker hub username as DOCKER_HUB_USERNAME
# 2. Your Docker hub access token DOCKER_HUB_ACCESS_PASSWORD
# Then commit.

name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  test:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9.14"]
    name: Run tests
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    - name: Set python version
      uses: actions/setup-python@v4
      with:
        python-version: '3.9.14'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        pip install poetry
        poetry config virtualenvs.create false
        poetry install
    - name: Perform gruesome hack
      run: |
        cp -r pyproject.toml src/stub.toml
        cp -r pyproject.toml src/tests/stub.toml
    - name: Run Pytest
      run: |
        cd src/
        pytest 

  push:

    name: Push to registry.
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    - name: Set python version
      uses: actions/setup-python@v4
      with:
        python-version: '3.9.14'
    - name: Perform gruesome hack
      run: |
        cp -r pyproject.toml src/stub.toml
    - name: Get version and tag image
      run: |
        pip install tomli
        cd src/
        echo "version=`python version.py`" >> $GITHUB_ENV
    - name: Login to registry
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_PASSWORD }}
    - name: Push to dockerhub
      run: |
        make VERSION=${{ env.version }} tag
        docker push {{ cookiecutter.docker_user }}/{{ cookiecutter.docker_repo }}:${{ env.version }}

